"""
Utility functions and constants for JAX implementation of efficient-fpt.

Contains pre-computed Gauss-Legendre quadrature nodes and weights.
"""

import jax.numpy as jnp

# Pre-computed Gauss-Legendre nodes and weights on [-1, 1]
# These are used for numerical integration in the multi-stage algorithm

GAUSS_LEGENDRE_10_X = jnp.array([
    -0.9739065285171717, -0.8650633666889845, -0.6794095682990244,
    -0.4333953941292472, -0.14887433898163122, 0.14887433898163122,
    0.4333953941292472, 0.6794095682990244, 0.8650633666889845,
    0.9739065285171717
])

GAUSS_LEGENDRE_10_W = jnp.array([
    0.06667134430868807, 0.14945134915058036, 0.219086362515982,
    0.2692667193099965, 0.295524224714753, 0.295524224714753,
    0.2692667193099965, 0.219086362515982, 0.14945134915058036,
    0.06667134430868807
])

GAUSS_LEGENDRE_20_X = jnp.array([
    -0.9931285991850949, -0.9639719272779138, -0.9122344282513258,
    -0.8391169718222188, -0.7463319064601508, -0.636053680726515,
    -0.5108670019508271, -0.37370608871541955, -0.2277858511416451,
    -0.07652652113349734, 0.07652652113349734, 0.2277858511416451,
    0.37370608871541955, 0.5108670019508271, 0.636053680726515,
    0.7463319064601508, 0.8391169718222188, 0.9122344282513258,
    0.9639719272779138, 0.9931285991850949
])

GAUSS_LEGENDRE_20_W = jnp.array([
    0.017614007139153273, 0.04060142980038622, 0.06267204833410944,
    0.08327674157670467, 0.10193011981724026, 0.11819453196151825,
    0.13168863844917653, 0.14209610931838187, 0.14917298647260366,
    0.15275338713072578, 0.15275338713072578, 0.14917298647260366,
    0.14209610931838187, 0.13168863844917653, 0.11819453196151825,
    0.10193011981724026, 0.08327674157670467, 0.06267204833410944,
    0.04060142980038622, 0.017614007139153273
])

GAUSS_LEGENDRE_30_X = jnp.array([
    -0.9968934840746495, -0.9836681232797473, -0.9600218649683075,
    -0.9262000474292743, -0.8825605357920526, -0.8295657623827684,
    -0.7677774321048262, -0.6978504947933158, -0.6205261829892429,
    -0.5366241481420199, -0.4470337695380892, -0.3527047255308781,
    -0.2546369261678899, -0.1538699136085835, -0.0514718425553177,
    0.0514718425553177, 0.1538699136085835, 0.2546369261678899,
    0.3527047255308781, 0.4470337695380892, 0.5366241481420199,
    0.6205261829892429, 0.6978504947933158, 0.7677774321048262,
    0.8295657623827684, 0.8825605357920526, 0.9262000474292743,
    0.9600218649683075, 0.9836681232797473, 0.9968934840746495
])

GAUSS_LEGENDRE_30_W = jnp.array([
    0.0079681924961695, 0.0184664683110911, 0.0287847078833229,
    0.0387991925696268, 0.0484026728305944, 0.0574931562176191,
    0.0659742298821803, 0.0737559747377048, 0.0807558952294198,
    0.0868997872010827, 0.0921225222377858, 0.096368737174644,
    0.0995934205867949, 0.1017623897484052, 0.1028526528935585,
    0.1028526528935585, 0.1017623897484052, 0.0995934205867949,
    0.096368737174644, 0.0921225222377858, 0.0868997872010827,
    0.0807558952294198, 0.0737559747377048, 0.0659742298821803,
    0.0574931562176191, 0.0484026728305944, 0.0387991925696268,
    0.0287847078833229, 0.0184664683110911, 0.0079681924961695
])


def lgwt_lookup_table(order: int, a: float, b: float):
    """
    Return scaled Gauss-Legendre nodes and weights for interval [a, b].
    
    Parameters
    ----------
    order : int
        Order of quadrature (10, 20, or 30 supported)
    a : float
        Lower bound of integration interval
    b : float
        Upper bound of integration interval
        
    Returns
    -------
    x : jnp.ndarray
        Quadrature nodes scaled to [a, b]
    w : jnp.ndarray
        Quadrature weights scaled for [a, b]
    """
    if order == 10:
        x_ref, w_ref = GAUSS_LEGENDRE_10_X, GAUSS_LEGENDRE_10_W
    elif order == 20:
        x_ref, w_ref = GAUSS_LEGENDRE_20_X, GAUSS_LEGENDRE_20_W
    elif order == 30:
        x_ref, w_ref = GAUSS_LEGENDRE_30_X, GAUSS_LEGENDRE_30_W
    else:
        raise ValueError(f"Order {order} not supported. Use 10, 20, or 30.")
    
    # Scale from [-1, 1] to [a, b]
    x = x_ref * (b - a) / 2 + (b + a) / 2
    w = w_ref * (b - a) / 2
    
    return x, w

